<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Indecision</title>
  <style>
    #map{
      height: 100%;
      width: 100%; 
      box-shadow: 3px 3px 5px grey;

    }
    #logoCont{
      display: none;
      margin-bottom: 1em;
      padding-top: 1em;
    }
    #logoCont1{
      margin: 1em 0 2em 0;
      padding-top: .5em;  
      padding-bottom: .5em;  
      background-color: #e1eaed;
      box-shadow: 3px 3px 5px black;
    }
    #homeLink{
      background-color: #c8d8e0 ;
      padding: .5em 1em .5em 1em;
      box-shadow: 3px 3px 5px grey;

    }
    a{
      float: right;
    }
    #map-jumbotron {
      width: 100%;
      height: 100%;
      margin: 1em auto 1em auto;
    }
    .mapDiv{
      height: 25em;
    }
    .title{
      height: 100%;
      }
    .results{
      margin: 1em;
    }
    ul {
      font-size: small;
      list-style-type: none;
      padding: .75em .25em .75em .25em;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      border-radius: 5px;
      box-shadow: 3px 3px 5px grey;

    } 
    li:nth-child(odd) {background-color: #f2f2f2;}
    li {
      padding: 1em;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      width: 100%;
      height: 100%;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <%- include("../partials/header") %> 
  <script>
    "use strict";
      let map;
      let service;
      let infowindow;
    var pos;

  function initMap() {
    let answer = document.getElementById('result').innerHTML;   
    
        infowindow = new google.maps.InfoWindow();
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            position => {
              const pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              map.setCenter(pos);
              var CurrentPos = new google.maps.Marker({
                      position:pos,
                      map:map,
                      icon: "https://www.google.com/intl/en_us/mapfiles/ms/micons/blue-dot.png"
                    });
            },
            () => {
              handleLocationError(true, infoWindow, map.getCenter());
            }
          );
        }
        map = new google.maps.Map(document.getElementById("map"), {
          center: pos,
          zoom: 12
        });
        const request = {
          query: answer,
          fields: ["name", "geometry"],
          locationBias: {radius: 100, center: pos}
        };
        service = new google.maps.places.PlacesService(map);
        if(request.query == false){
          $('div[id="resultsDiv"]').addClass("hidden")
          } else {
        service.textSearch(request, (results, status) => {  
          if(results == false){
            document.getElementById('h1Header').innerHTML = "No results for (" + request.query + "). Try searching again!"
            $('div[id="resultsDiv"]').addClass("hidden")

          } else {  

          if (status === google.maps.places.PlacesServiceStatus.OK) {
            for (let i = 0; i < 5; i++) {
              createMarker(results[i]);

              // const placesList = document.getElementById("places");
              // const li = document.createElement("li");
              const resultCont = document.getElementById('resCards');
              
              const placeUrl = "https://www.google.com/maps/search/?api=1&query=" + encodeURI(results[i].name);


              // add name, rating and info link to each li
              const resultsCards = `
              <li>
              <div class="card col-12">
                <img id="cardImg" src="${results[i].photos[0].getUrl()}" class="card-img-top" alt="https://images.unsplash.com/photo-1499028344343-cd173ffc68a9?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1050&q=80">
                <div class="card-body">
                  <h5 class="card-title">${results[i].name}</h5>
                  <p class="card-text">$ ${results[i].price_level}/5</p>
                  <p class="card-text">Rating: ${results[i].rating} </p>
                  <a id="resCardLink" href="${placeUrl}" target="_blank" class="btn btn-primary">Get More Info!</a>
                </div>
              </div>
            </li>
            `;
            resultCont.innerHTML += resultsCards;
              
              }
            }
          }
        });
      }



      function currentSpotMarker(props){
        var marker = new google.maps.Marker({
          postion:props.coords,
          map:map,
          icon:props.iconImage
        })
      }
      function createMarker(place) {
        const marker = new google.maps.Marker({
          map,
          position: place.geometry.location
        });
        marker.addListener("mouseover", function() {
        var inforwindow = new google.maps.InfoWindow({
        })
          var directionLink = "https://www.google.com/maps/search/?api=1&query=";
          infowindow.setContent(place.name + '</br>' + '<a href="https://www.google.com/maps/search/?api=1&query=' + encodeURI(place.name) + '"target="_blank">' + "More Info" + '</a>' );
          infowindow.open(map, marker);
        });
      }

      
    }
      
  </script>
  

<div id="logoCont1" class="container-fluid row-12 col-12">
  <div class="container-fluid col-lg-8 col-md-12 col-sm-12">
    <div class="row">
      <div class="col-8" id="logoBanner">
        <a id="logo" href="/">Indecision <i class="fab fa-get-pocket"></i></a>
      </div>
      <div class="col-4">
        <a id="home" href="/start">Home</a>
      </div>
    </div>
  </div>
</div>
  <div class="containter-fluid col-12">

  <div id="map-jumbotron" class="jumbotron col-md-8 ">

    <div class="row title">
      <div class="col-8">
        <h1 id="h1Header">Nearby Results for - <%= answer %></h1>
         <h2 style="visibility: hidden;" id="result"><%= answer %></h2>
      </div>

      <div class="col-4" id="goBackBtn">
        <a id="homeLink" href="/start">Go Home</a>
      </div>
    </div>

    <div class="row mapDiv">
      <div class="col-12 ">
            <div id="map"></div>
      </div>
    </div>
      <hr>
      <div id="resultsDiv" class="row results">
        <div class="col-12">
        <div id="right-panel">
          <h2>Top Results for "<%= answer %>"!</h2>
          <div id="resCardsDiv" class="col-12">
            <ul id="resCards"></ul>
          </div>
          
        </div>
      </div>
      </div>
  </div>
</div>
</div>
</body>
</html>