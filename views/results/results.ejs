<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Indecision</title>

  <style>
    #map{
      height: 100%;
      width: 100%;
    }

    #goBackBtn{
      background-color: #c8d8e0 ;
      padding: 1em 3em 1em 3em;
      top: -1em;
      justify-self: center;
      margin: 0 3em 2em 0;
      font-size: 1.1em;
      border-radius: 10px;
    }

    .col-4 {
    float: right;
    top: -1.5em;
    }

    a{
      float: right;
      margin-right: 1em;
    }
    
      #map-jumbotron {
        width: 100%;
        height: 50em;
        margin: 1em auto 1em auto;
        padding: auto
      }

      .mapDiv{
        height: 25em;
        top: -4em;
        padding: none;
        border: #c8d8e0 solid;
      }

      .title{
        top: -2em;      
        }

      .results{
        width: 100%;
        height: 15em;
        top: -4em;
        justify-content: center;
        background-color: #c8d8e0;
        border-radius: 5px;
        padding: 1em;
        margin-top: 5px
      }

      h2 {
        padding: .25em;
        margin: 0;
        border-bottom-width: 0;
        background-color:#f2f2f2;
        border-radius: 5px;
        text-align: center;
      }

      ul {
        list-style-type: none;
        padding: .5em 0 .5em 0;
        margin: 0;
        width: 100%;
        height: 100%;
        /* overflow-y: scroll; */
        border-radius: 5px;
      } 
      li:nth-child(odd) {background-color: #f2f2f2;}


      li {
        padding: .1em;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
        width: 100%;
        height: 100%;
        border-radius: 5px;
      }


  </style>
</head>
<body>
  <%- include("../partials/header") %> 

  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
 
  <script>
    "use strict";
      let map;
      let service;
      let infowindow;
    var pos;

    
  function initMap() {
    let answer = document.getElementById('result').innerHTML;   
    
        infowindow = new google.maps.InfoWindow();
        // -----------------------------------------
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            position => {
              const pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              map.setCenter(pos);
              var CurrentPos = new google.maps.Marker({
                      position:pos,
                      map:map,
                      icon: "https://www.google.com/intl/en_us/mapfiles/ms/micons/blue-dot.png"
                      // icon:'http://maps.google.com/mapfiles/kml/paddle/blu-blank-lv.png'
                    });


            },
            () => {
              handleLocationError(true, infoWindow, map.getCenter());
            }
          );
        }

        map = new google.maps.Map(document.getElementById("map"), {
          center: pos,
          zoom: 12
        });

        const request = {
          query: answer,
          fields: ["name", "geometry"],
          locationBias: {radius: 100, center: pos}

        };
        service = new google.maps.places.PlacesService(map);
        service.textSearch(request, (results, status) => {  
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            for (let i = 0; i < 5; i++) {
              const placesList = document.getElementById("places");
              const li = document.createElement("li");
              // add name, rating and info link to each li
              li.textContent =" - " + results[i].rating + " - " + results[i].name;
              var button = document.createElement("a")
              button.setAttribute('href',"https://www.google.com/maps/search/?api=1&query=" + encodeURI(results[i].name))
              button.setAttribute('target',"_blank")
              li.appendChild(button);
              button.innerHTML="More Info"
              placesList.appendChild(li);
              createMarker(results[i]);
            }
          }
        });
      }

      function currentSpotMarker(props){
        var marker = new google.maps.Marker({
          postion:props.coords,
          map:map,
          icon:props.iconImage
        })
      }

      function createMarker(place) {
        const marker = new google.maps.Marker({
          map,
          position: place.geometry.location
        });
        marker.addListener("click", function() {
        var inforwindow = new google.maps.InfoWindow({
        })
          var directionLink = "https://www.google.com/maps/search/?api=1&query=";

          infowindow.setContent(place.name + '</br>' + '<a href="https://www.google.com/maps/search/?api=1&query=' + encodeURI(place.name) + '"target="_blank">' + "More Info" + '</a>' );
          infowindow.open(map, marker);
        });
      }
    
  </script>
  
 <script
 src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAVTONnjQDRFUmOBIVDA7306DTuTWPJfAw&callback=initMap&libraries=places&v=weekly"
 async
></script>
<div class="container">

  <div id="map-jumbotron" class="jumbotron row-md-12">

    <div class="row">
      <div class="col-8 title">
        <h1>Nearby Results for - <%= answer %></h1>
        
         <h2 style="visibility: hidden;" id="result"><%= answer %></h2>
      </div>

      <div class="col-4">
        <a id="goBackBtn" href="/start">Go Back</a>
      </div>

      <div class="col-md-12 mapDiv">
            <div id="map"></div>
      </div>
      <hr>
      <div class="col-md-12 results">
        <div id="right-panel">
          <h2>Top Results for "<%= answer %>"!</h2>
          <ul id="places"></ul>
        </div>
      </div>
        
    </div>

  </div>

</div>



</body>
</html>